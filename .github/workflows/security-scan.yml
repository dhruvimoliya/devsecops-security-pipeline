name: Security Scan Pipleline

on:
    push:
        branches: [main, master]
    pull_request:
        branches: [main, master]
    worlkflow_dispatch:

jobs:
    secret-scan:
        name: Secret detection
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v3
              with:
                  fetch-depth: 0

            - name: Gitleaks sceret scan
              uses: zricethezav/gitleaks-action@v1.3.0
              env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}           

sast-bandit:
    name: Python security analysis(Bandit)
    runs-on: ubuntu-latest
    steps:
        - name: Checkout code
          uses: actions/checkout@v3

        - name: Setup python
          uses: actions/setup-python@v4
          with:
            python-version: '3.11'

        - name: Install Bandit
          run: |
            pip install bandit[toml]
            bandit --version

        - name: Run Bandit scan
          run: |
            echo "Running Bandit security scan......"
            bandit -r . -f json -o bandit-report.json || true
            echo ""
            echo " Bandit scan complete. Displaying results:"
            bandit -r . -f screen || true
          continue-on-error: true

        - name: Upload Bandit report
          uses: actions/upload-artifact@v3
          if: always()
          with:
            name: bandit-security-report
            path: bandit-report.json

sast-semgrep:
    name: Multi-language security analysis(Semgrep)
    runs-on: ubuntu-latest
    container:
        image: returntocorp/semgrep
    steps:
        - name: Checkout Code
          uses: actions/checkout@v3

        - name: Run Semgrep Scan
          run: |
            echo "Running semgrep security scan....."
            smegrep scan --config=auto --json -o semgrep-results.json || true
            echo ""
            echo "Semgrep scan complete. Displaying results:"
            semgrep scan --config=auto || true
          continue-on-error: true

        - name: Upload Semgrep Report
          uses: actions/upload-artifact@v3
          if: always()
          with: 
            name: semgrep-security-report
            path: semgrep-results.json

dependency-scan:
    name: Dependency Vulnerabilty Scan
    runs-on: ubuntu-latest
    steps:
        - name: CHeckout Code
          uses: actions/checkout@v3

        - name: Setup Python
          uses: actions/setup-python@v4
          with:
            python-version: '3.11'
        
        - name: Install pip-audit
          run: |
            pip install pip-audit
            pip-audit --version

        - name: Scan Python Dependencies
          run: |
            echo "Scanning python dependencies for vulnerabilities......"
            pip-audit -- requirement sample-app/requirements.txt -- format json > pip-audit-report.json || true
            echo ""
            echo "Dependency scan complete. Displaying results:"
            pip-audit --requirement sample-app/requirements.txt || true 
          continue-on-error: true

        - name: Upload Dependency Report
          uses: actions/upload-artifact@v3
          if: always()
          with:
            name: dependency-vulnerability-report
            path: pip-audit-report.json

code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    steps:
        - name: Checkout Code
          uses: actions/checkout@v3

        - name: Setup Python
          uses: actions/setup-python@v4
          with:
            python-version: '3.11'

        - name: Install Tools
          run: | 
            pip install pylint safety

        - name: Run Safety Check
          run: |
            echo "Running Safety Vulnerablity Check......"
            safety check --json --file sample-app/requiremets.txt > safety-report.json || true
            safety check --file sample-app/requirements.txt || true
          continue-on-error: true

        - name: Upload Safety Report
          uses: actions/upload-artifact@v3
          if: always()
          with:
            name: safety-check-report
            path: safety-report.json

security-summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs: [secret-scan, sast-bandit, sast-semgrep, dependency-scan, code-quality]
    steps:
        - name: Checkout Code
          uses: actions/checkout@v3

        - name: Download All Artifacts
          uses: actions/download-artifact@v3
          continue-on-error: true

        - name: Display Security Summary
          run: |
           echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
           echo "â•‘                                                            â•‘"
           echo "â•‘       Security Scan Pipeline - Execution Complete          â•‘"
           echo "â•‘                                                            â•‘"
           echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
           echo ""
           echo "Scan Results Summary:"
           echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
           echo ""
           echo " Secret Scanning (Gitleaks)      : Completed"
           echo " SAST - Python (Bandit)          : Completed"
           echo " SAST - Multi-Language (Semgrep) : Completed"
           echo " Dependency Scan (pip-audit)     : Completed"
           echo " Additional Checks (Safety)      : Completed"
           echo ""
           echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
           echo ""
           echo " Generated Artifacts:"
           echo "  â€¢ bandit-security-report.json"
           echo "  â€¢ semgrep-security-report.json"
           echo "  â€¢ dependency-vulnerability-report.json"
           echo "  â€¢ safety-check-report.json"
           echo ""
           echo " Download artifacts from the workflow run page"
           echo ""
           echo "ðŸŽ¯ Expected Findings (Demo App):"
           echo "  â€¢ Hardcoded secrets detected"
           echo "  â€¢ SQL injection vulnerabilities"
           echo "  â€¢ Command injection issues"
           echo "  â€¢ Insecure deserialization"
           echo "  â€¢ Vulnerable dependencies"
           echo ""
           echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
           echo ""
           echo " DevSecOps Security Pipeline by Dhruvi Moliya"
           echo ""

        - name: Create Summary Badge
          run: | 
            echo "Security scan completed on $(date)" > scan_summary.txt
            echo "Total scans executed: 5" >> scan-summary.txt
            echo "Pipeline status: Sucess" >> scan_summary.txt

        - name: Upload Summary
          uses: actions/upload-artifact@v3
          with:
            name: security-scan-summary
            path: scan_summary.txt